<html>
	<head>
		<script src='data.js'></script>
		<script> let cardSize = 5; </script>
		<style>
			body
			{
				background-color: black;
				color: white;
			}
			#deckList
			{
				margin-bottom: 1em;
			}
			#currentDeck
			{
				border: 2px solid yellow;
				display: inline-block;
				cursor: move;
			}
			.card
			{
				position: absolute;
				display: inline-block;
				cursor: move;
			}
		</style>
	</head>

	<body>
		<select id='deckList'></select> &nbsp;
		<button id='btnClear'>Clear</button> &nbsp;
		<input type='checkbox'>Magnify</input>
		<br/>
		<img id='currentDeck'/>
	</body>

	<script>
		var deckList = document.getElementById("deckList");
		var currentDeck = document.getElementById("currentDeck");
		var body = document.getElementsByTagName("body")[0];

		currentDeck.style.width = cardSize + "em";

		function loadImageData(parentObject, property, onDone, asCanvas)
		{
			if (typeof parentObject[property] === 'string' || parentObject[property] instanceof String)
			{
				let image = new Image();
				image.addEventListener("load", function()
				{
					if (!asCanvas)
					{
						parentObject[property] = image;
						onDone(image);
					}
					else
					{
						let canvas = document.createElement("CANVAS");
						canvas.width = image.width;
						canvas.height = image.height;
						let ctx = canvas.getContext("2d");
						ctx.drawImage(image, 0, 0);
						parentObject[property] = canvas;
						onDone(canvas);
					}
				});
				image.src = "media/" + parentObject[property];
			}
			else
			{
				onDone(parentObject[property]);
			}
		}

		function getSubImage(img, x, y, w, h)
		{
			let cardWidth = cardSize;
			let cardHeight = cardSize * h/w;
			let result = document.createElement("SPAN");
			result.classList.add("card");
			result.style.width = cardWidth + "em";
			result.style.height = cardHeight + "em";
			result.style["background-position-x"] = (-1 * cardWidth * x / w) + "em";
			result.style["background-position-y"] = (-1 * cardHeight * y / h) + "em";
			result.style["background-image"] = "url(" + img.src + ")";
			result.style["background-size"] = (cardSize * img.width / w) + "em";
			return result;
		}

		function loadDeck(deck)
		{
			// If deck already loaded, just use it as-is
			if (deck.loaded)
			{
				currentDeck.src = deck.backImage.src;
				return;
			}

			// Load the deck
			loadImageData(deck, "backImage", function(img)
			{
				currentDeck.src = img.src;
			});
			let countdown = deck.images.length;
			for (var i = 0; i < deck.images.length; i++)
			{
				loadImageData(deck.images, i, function(img)
				{
					countdown--;
/*					if (countdown == 0)
					{
						// Slice all cards from images
						for (var k = 0; k < deck.cards.length; k++)
						{
							if (deck.cards[k] instanceof Array)
							{
							//	deck.cards[k] = getSubImage(
							//		deck.images[deck.cards[k][0]],
							//		deck.cards[k][1],
							//		deck.cards[k][2],
							//		deck.w,
							//		deck.h);

								let srcCanvas = deck.images[deck.cards[k][0]];
								let srcCtx = srcCanvas.getContext("2d");
								let dstCanvas = document.createElement("CANVAS");
								dstCanvas.width = deck.w;
								dstCanvas.height = deck.h;
								dstCanvas.style.width = cardSize + "em";
								dstCanvas.classList.add("card");
								let dstCtx = dstCanvas.getContext("2d");
								dstCtx.putImageData(srcCtx.getImageData(deck.cards[k][1], deck.cards[k][2], deck.w, deck.h), 0, 0);
								deck.cards[k] = dstCanvas;
							}
						}
						// Remember that this deck has been loaded
						decks[deckList.value].loaded = true;
					}
*/				}, true);
			}
		}

		// React to selecting a deck with the dropdown
		function onDeckSet()
		{
			loadDeck(decks[deckList.value]);
		}

		// Init dropdown of decks
		for (var i = 0; i < decks.length; i++)
		{
			deckList.innerHTML += "<option value='" + i + "'>" + decks[i].name + "</option>";
		}
		deckList.addEventListener("change", onDeckSet);
		onDeckSet();

		// Clear button handling
		document.getElementById("btnClear").addEventListener("click", function()
		{
			var cards = document.getElementsByClassName("card");
			while (cards[0])
			{
				cards[0].parentNode.removeChild(cards[0]);
			}
		});

		function onDeckDragStart(evt)
		{
			evt = evt || window.event;
			evt.preventDefault();
			let deckRect = currentDeck.getBoundingClientRect();
			let rndIndex = Math.floor(Math.random() * decks[deckList.value].cards.length);
//			let newCard = decks[deckList.value].cards[rndIndex].cloneNode(true);

								let deck = decks[deckList.value];
								let srcCanvas = deck.images[deck.cards[rndIndex][0]];
								let srcCtx = srcCanvas.getContext("2d");
								let dstCanvas = document.createElement("CANVAS");
								dstCanvas.width = deck.w;
								dstCanvas.height = deck.h;
								dstCanvas.style.width = cardSize + "em";
								dstCanvas.classList.add("card");
								let dstCtx = dstCanvas.getContext("2d");
								dstCtx.putImageData(srcCtx.getImageData(deck.cards[rndIndex][1], deck.cards[rndIndex][2], deck.w, deck.h), 0, 0);

			let newCard = dstCanvas;

//			newCard.getContext("2d").drawImage(decks[deckList.value].cards[rndIndex], 0, 0);
			newCard.addEventListener("touchstart", onCardDragStart, false);
			newCard.addEventListener("mousedown", onCardDragStart, false);
			newCard.style.left = deckRect.left;
			newCard.style.top = deckRect.top;
			cardBeingDragged = newCard;
			body.appendChild(newCard);
			dragOffsetX = evt.clientX - deckRect.left;
			dragOffsetY = evt.clientY - deckRect.top;
			document.onmouseup = onCardDragEnd;
			document.onmousemove = onCardDragging;
		}
		currentDeck.addEventListener("touchstart", onDeckDragStart, false);
		currentDeck.addEventListener("mousedown", onDeckDragStart, false);

		let cardBeingDragged = 0;
		let dragOffsetX = 0;
		let dragOffsetY = 0;
		function onCardDragStart(evt)
		{
			evt = evt || window.event;
			evt.preventDefault();
			cardBeingDragged = evt.target;
			dragOffsetX = evt.clientX - Number(cardBeingDragged.style.left.replace("px", ""));
			dragOffsetY = evt.clientY - Number(cardBeingDragged.style.top.replace("px", ""));
			document.onmouseup = onCardDragEnd;
			document.onmousemove = onCardDragging;
		}
		function onCardDragging(evt)
		{
			evt = evt || window.event;
			evt.preventDefault();
			cardBeingDragged.style.left = evt.clientX - dragOffsetX;
			cardBeingDragged.style.top = evt.clientY - dragOffsetY;
		}
		function onCardDragEnd(evt)
		{
			document.onmouseup = null;
			document.onmousemove = null;
		}
	</script>
</html>
