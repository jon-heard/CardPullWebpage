<html>
	<head>
		<script src='data.js'></script>
		<script> let cardSize = 5; </script>
		<style>
			body
			{
				background-color: black;
				color: white;
			}
			#deckList
			{
				margin-bottom: 1em;
			}
			#deckUi
			{
				border: 2px solid yellow;
				display: inline-block;
				cursor: move;
			}
			#loadingUi
			{
				position: absolute;
				cursor: not-allowed;
				display: flex;
				justify-content: center;
				align-items: center;
				user-select: none;
			}
			.card
			{
				position: absolute;
				display: inline-block;
				cursor: move;
				box-shadow: 3px 3px 5px rgba(0,0,0,.85);
			}
			.showAllCard
			{
				position: static;
				margin: 0.25em;
			}
			.dragged
			{
				box-shadow: 20px 20px 10px rgba(0,0,0,.75);
			}
			.magnified
			{
				left: 0;
				top: 0;
				height: 100%;
				z-index: 100;
			}
		</style>
	</head>

	<body>
		<select id='deckList'></select> &nbsp;
		<button id='btnClear'>Clear</button> &nbsp;
		<button id='btnShowAll'>Show All</button> &nbsp;
		<br/>
		<div><canvas id='deckUi'></canvas></div>
		<span id='loadingUi'>Loading...</canvas>
		<br/>
	</body>

	<script>
		//////////
		// BODY //
		//////////
		var body = document.getElementsByTagName("body")[0];


		//////////////////
		// DECK UI //
		//////////////////
		var deckUi = document.getElementById("deckUi");
		deckUi.style.width = cardSize + "em";


		////////////////
		// LOADING UI //
		////////////////
		var loadingUi = document.getElementById("loadingUi");
		function initLoadingUi() // Encapsulating for local scope for temp vars
		{
			let deckUiRect = deckUi.getBoundingClientRect();
			loadingUi.style.left = deckUiRect.left;
			loadingUi.style.top = deckUiRect.top;
			loadingUi.style.width = deckUiRect.width;
		}
		initLoadingUi();
		function showLoadingUi()
		{
			loadingUi.style.height = deckUi.getBoundingClientRect().height;
			loadingUi.style.display = "flex";
		}
		function hideLoadingUi()
		{
			loadingUi.style.display = "none";
		}


		///////////////////
		// LIST OF DECKS //
		///////////////////
		var deckList = document.getElementById("deckList");
		for (var i = 0; i < decks.length; i++)
		{
			deckList.innerHTML += "<option value='" + i + "'>" + decks[i].name + "</option>";
		}
		function onDeckSelected()
		{
			loadDeck(decks[deckList.value]);
		}
		deckList.addEventListener("change", onDeckSelected);
		onDeckSelected();


		//////////////////
		// CLEAR BUTTON //
		//////////////////
		document.getElementById("btnClear").addEventListener("click", function()
		{
			var cards = document.getElementsByClassName("card");
			while (cards[0])
			{
				cards[0].parentNode.removeChild(cards[0]);
			}
		});


		//////////////
		// SHOW ALL //
		//////////////
		document.getElementById("btnShowAll").addEventListener("click", function()
		{
			let deck = decks[deckList.value];
			let newCards = [];
			for (var i = 0; i < deck.cards.length; i++)
			{
				let card = createCard(deck, i);
				card.classList.add("showAllCard");
				newCards.push(card);
			}
			for (var i = 0; i < newCards.length; i++)
			{
				let rect = newCards[i].getBoundingClientRect();
				newCards[i].style.left = rect.left;
				newCards[i].style.top = rect.top;
			}
			for (var i = 0; i < newCards.length; i++)
			{
				newCards[i].classList.remove("showAllCard");
			}
		});


		// Load image into a canvas
		function loadImage(parentObject, property, onDone)
		{
			if (typeof parentObject[property] === 'string' || parentObject[property] instanceof String)
			{
				let image = new Image();
				image.addEventListener("load", function()
				{
					let canvas = document.createElement("CANVAS");
					canvas.width = image.width;
					canvas.height = image.height;
					canvas.getContext("2d").drawImage(image, 0, 0);
					parentObject[property] = canvas;
					if (onDone) { onDone(canvas); }
				});
				image.src = "media/" + parentObject[property];
			}
			else
			{
				 if (onDone) { onDone(parentObject[property]); }
			}
		}


		// Called when user sets the current deck
		function loadDeck(deck)
		{
			// If deck was previously loaded, just set it and return
			if (deck.loaded)
			{
				deckUi.width = deck.backImage.width;
				deckUi.height = deck.backImage.height;
				deckUi.getContext("2d").drawImage(deck.backImage, 0, 0);
				return;
			}

			// Disable deckUi while loading the deck
			showLoadingUi();
			deckUi.getContext("2d").clearRect(0, 0, deckUi.width, deckUi.height);
			// Load the deck
			let countdown = deck.images.length;
			for (var i = 0; i < deck.images.length; i++)
			{
				loadImage(deck.images, i, function(img)
				{
					countdown--;
					if (countdown == 0)
					{
						deck.loaded = true;
						// Enable DeckUi once all deck images are loaded
						loadImage(deck, "backImage", function(img)
						{
							deckUi.width = img.width;
							deckUi.height = img.height;
							deckUi.getContext("2d").drawImage(img, 0, 0);
							hideLoadingUi();
						});
					}
				});
			}
		}


		//////////////////////////////////
		// Create card by dragging deck //
		//////////////////////////////////
		function onDeckDrag(evt)
		{
			evt = evt || window.event;
			evt.preventDefault();
			let deck = decks[deckList.value];
			let card = createCard(deck, Math.floor(Math.random() * deck.cards.length));
			if (!card)
			{
				return;
			}
			let deckUiRect = deckUi.getBoundingClientRect();
			card.style.left = deckUiRect.left;
			card.style.top = deckUiRect.top;

			cardBeingDragged = card;
			cardBeingDragged.classList.add("dragged");
			dragOffsetX = evt.clientX - deckUiRect.left;
			dragOffsetY = evt.clientY - deckUiRect.top;
			document.addEventListener("mouseup", onCardDragEnd);
			document.addEventListener("mousemove", onCardDragging);
		}
		deckUi.addEventListener("touchstart", onDeckDrag);
		deckUi.addEventListener("mousedown", onDeckDrag);
		function createCard(deck, index)
		{
			if (!deck.loaded)
			{
				return null;
			}
			let srcCanvas = deck.images[deck.cards[index][0]];
			let newCard = document.createElement("CANVAS");
			newCard.width = deck.w;
			newCard.height = deck.h;
			newCard.getContext("2d").drawImage(srcCanvas, deck.cards[index][1], deck.cards[index][2], deck.w, deck.h, 0, 0, deck.w, deck.h);
			newCard.style.width = cardSize + "em";
			newCard.classList.add("card");
			newCard.addEventListener("touchstart", onCardDragStart);
			newCard.addEventListener("mousedown", onCardDragStart);
			newCard.addEventListener("mousemove", onHover);
			newCard.addEventListener("mouseleave", onUnhover);
			newCard.addEventListener("dblclick", onDoubleClick);
			body.appendChild(newCard);
			return newCard;
		}


		////////////////////
		// Dragging cards //
		////////////////////
		let cardBeingDragged = 0;
		let dragOffsetX = 0;
		let dragOffsetY = 0;
		function onCardDragStart(evt)
		{
			evt = evt || window.event;
			evt.preventDefault();
			cardBeingDragged = evt.target;
			cardBeingDragged.classList.add("dragged");
			body.appendChild(cardBeingDragged);
			dragOffsetX = evt.clientX - Number(cardBeingDragged.style.left.replace("px", ""));
			dragOffsetY = evt.clientY - Number(cardBeingDragged.style.top.replace("px", ""));
			document.addEventListener("mouseup", onCardDragEnd);
			document.addEventListener("mousemove", onCardDragging);
		}
		function onCardDragging(evt)
		{
			evt = evt || window.event;
			evt.preventDefault();
			cardBeingDragged.style.left = evt.clientX - dragOffsetX;
			cardBeingDragged.style.top = evt.clientY - dragOffsetY;
		}
		function onCardDragEnd(evt)
		{
			cardBeingDragged.classList.remove("dragged");
			document.removeEventListener("mouseup", onCardDragEnd);
			document.removeEventListener("mousemove", onCardDragging);
		}


		/////////////
		// Magnify //
		/////////////
		let currentHovered = null;
		let currentMagnified = null;
		let currentMagnified_left = 0;
		let currentMagnified_top = 0;
		let currentMagnified_width = 0;
		document.addEventListener("keydown", function(evt)
		{
			if(evt.key == "Control" && currentHovered)
			{
				currentMagnified = currentHovered;
				currentMagnified_left = currentMagnified.style.left;
				currentMagnified_top = currentMagnified.style.top;
				currentMagnified_width = currentMagnified.style.width;
				currentMagnified.style.left = "";
				currentMagnified.style.top = "";
				currentMagnified.style.width = "";
				currentMagnified.classList.add("magnified");
			}
		});
		document.addEventListener("keyup", function(evt)
		{
			if(evt.key == "Control" && currentMagnified)
			{
				currentMagnified.style.left = currentMagnified_left;
				currentMagnified.style.top = currentMagnified_top;
				currentMagnified.style.width = currentMagnified_width;
				currentMagnified.classList.remove("magnified");
			}
		});
		function onHover(evt)
		{
			currentHovered = evt.target;
		}
		function onUnhover(evt)
		{
			currentHovered = null;
		}


		///////////////////
		// Card deletion //
		///////////////////
		function onDoubleClick(evt)
		{
			evt.target.remove();
		}
	</script>
</html>
